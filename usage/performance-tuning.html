<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance Tuning &mdash; Mosaic</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Models" href="../models/models.html" />
    <link rel="prev" title="Automatic SQL registration" href="automatic-sql-registration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Mosaic
            <img src="../_static/mosaic_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../api/api.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">Installation guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="install-gdal.html">GDAL Installation guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid-indexes.html">Using grid index systems in Mosaic</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid-indexes-bng.html">BNG - British National Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Quickstart notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="kepler.html">Kepler visualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="automatic-sql-registration.html">Automatic SQL registration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Performance Tuning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../literature/videos.html">Mosaic Videos and Talks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mosaic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="usage.html">Usage</a></li>
      <li class="breadcrumb-item active">Performance Tuning</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/usage/performance-tuning.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="performance-tuning">
<h1>Performance Tuning<a class="headerlink" href="#performance-tuning" title="Permalink to this headline"></a></h1>
<div class="section" id="data-engineering">
<h2>Data Engineering<a class="headerlink" href="#data-engineering" title="Permalink to this headline"></a></h2>
<p>It is important for customers to have Data Engineering (DE) tables tuned for performance. Mosaic has been designed to operate directly on standard interchange formats which may appear in various DataFrame columns; currently, WKT, WKB, and GeoJSON are supported, with WKB offering the best properties for storing and querying. Further, while capabilities are always advancing, Mosaic does not expose geometry types as defined in <a class="reference external" href="https://www.ogc.org/standard/sfs/">OGC Simple Features for SQL</a>, making investments in DE all the more beneficial. Additionally, for best tuning, pre-standardize all your geospatial data into the same SRID; for most applications, this should be 4326, see <a class="reference external" href="https://databrickslabs.github.io/mosaic/usage/grid-indexes-bng.html#coordinate-reference-system">CRS Docs</a>. <em>As of Mosaic 0.3 series, customers need to prepare tables for performant queries, though we are exploring options to improve this experience going forward.</em></p>
<div class="section" id="polygons-lines">
<h3>Polygons &amp; Lines<a class="headerlink" href="#polygons-lines" title="Permalink to this headline"></a></h3>
<p>The best pattern for DE looks something like the following (column names are notional):</p>
<ol class="arabic simple">
<li><p>Call Mosaic’s <a class="reference external" href="https://databrickslabs.github.io/mosaic/api/spatial-indexing.html#grid-tessellateexplode">grid_tessellateexplode</a> on your geometries at a given resolution; in addition to exploding to per row, this adds an <code class="docutils literal notranslate"><span class="pre">index</span></code> column, a struct with the following fields: <code class="docutils literal notranslate"><span class="pre">is_core</span></code>, <code class="docutils literal notranslate"><span class="pre">index_id</span></code>, <code class="docutils literal notranslate"><span class="pre">wkb</span></code>; you essentially now have the result of H3 covers operation on the geometries and knowledge of which index space is fully contained within the geometry and WKB chips for the boundaries as well as core index; this is the fundamental call for performance</p></li>
<li><p>Call something like <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">index.*,</span> <span class="pre">*</span> <span class="pre">except(index)</span></code> to pull the struct fields into top level columns; also, adding them first to ensure they are part of the table statistics; you can be more thoughtful based on your data, e.g. don’t need WKB in the statistics</p></li>
<li><p>Save the table as delta lake and call <code class="docutils literal notranslate"><span class="pre">optimize</span> <span class="pre">&lt;table</span> <span class="pre">or</span> <span class="pre">delta</span> <span class="pre">path&gt;</span> <span class="pre">zorder</span> <span class="pre">(index_id)</span></code> to get proper layout</p></li>
</ol>
</div>
<div class="section" id="points">
<h3>Points<a class="headerlink" href="#points" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Points can be easily placed into a resolution as a point will only exists in a single cell; one strategy can be to populate a field at resolution 15 (the lowest for H3) and then use <a class="reference internal" href="#databricks-photon-apis">Databricks Photon APIs</a> to efficiently get to any higher parent</p></li>
<li><p>Save the table as delta lake and call <code class="docutils literal notranslate"><span class="pre">optimize</span> <span class="pre">&lt;table</span> <span class="pre">or</span> <span class="pre">delta</span> <span class="pre">path&gt;</span> <span class="pre">zorder</span> <span class="pre">(index_id)</span></code> to get proper layout</p></li>
</ol>
</div>
</div>
<div class="section" id="optimizing-queries">
<h2>Optimizing Queries<a class="headerlink" href="#optimizing-queries" title="Permalink to this headline"></a></h2>
<p>Once DE steps have been accomplished, your query pattern can look like the following, e.g. for point-in-polygon:</p>
<ol class="loweralpha simple">
<li><p>when you are only interested in approximate results, compare only for cell matches</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- H3 APPROXIMATE ONLY RESULTS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">poly_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">pnt_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">index_id</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>when you are interested in precise results, test boundary chip information</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- H3 + PRECISE RESULTS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">poly_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">pnt_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">L</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="k">AND</span>
<span class="w">    </span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">is_core</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">st_contains</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">wkb</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">geom_wkb</span><span class="p">))</span>
</pre></div>
</div>
<p><em>If only H3 approximate results are needed, you have the option to drop the WKB in tables after performing DE steps.</em></p>
<p>These are the main steps; however, when indexing wide area polygons as found in worldwide data, we would recommend a little more nuance to the core pattern, e.g. considering there are <a class="reference external" href="https://h3geo.org/docs/core-library/restable/">1.6 Trillion cells</a> that tessellate the globe at H3 resolution 12,  but only 4.8 billion at 9 (default <code class="docutils literal notranslate"><span class="pre">res_b</span></code> below) and 2 million at 5 (default <code class="docutils literal notranslate"><span class="pre">res_a</span></code> below).  For large areas, recommend a pattern like the following (showing python):</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df_a</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">)</span>
    <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">num_parts</span><span class="p">)</span> <span class="c1"># (optional)</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
      <span class="sa">f</span><span class="s2">&quot;* except(</span><span class="si">{</span><span class="n">in_geom_col</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;grid_tessellateexplode(</span><span class="si">{</span><span class="n">in_geom_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">res_a</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_a</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">res_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
      <span class="s2">&quot;index.*&quot;</span><span class="p">,</span>
      <span class="s2">&quot;* except(index)&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;index_id&quot;</span><span class="p">,</span> <span class="n">cell_col</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;wkb&quot;</span><span class="p">,</span> <span class="n">out_geom_col</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_core&quot;</span><span class="p">,</span> <span class="n">is_core_col</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df_b</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">df_a</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">is_core_col</span><span class="si">}</span><span class="s2"> = false&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
      <span class="sa">f</span><span class="s2">&quot;* except(</span><span class="si">{</span><span class="n">cell_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">is_core_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">out_geom_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">res_col</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
      <span class="sa">f</span><span class="s2">&quot;grid_tessellateexplode(</span><span class="si">{</span><span class="n">out_geom_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">res_b</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_b</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">res_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
      <span class="s2">&quot;index.*&quot;</span><span class="p">,</span>
      <span class="s2">&quot;* except(index)&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;index_id&quot;</span><span class="p">,</span> <span class="n">cell_col</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;wkb&quot;</span><span class="p">,</span> <span class="n">out_geom_col</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_core&quot;</span><span class="p">,</span> <span class="n">is_core_col</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df_res</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">df_a</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">is_core_col</span><span class="si">}</span><span class="s2"> = true&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df_b</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">## - While going above 9 is &quot;doable&quot;, e.g.</span>
<span class="c1">##   11 bloats the number of rows by multiple of 7^2 = 49</span>
<span class="c1">##   13 bloats the number of rows by multiple of 7^4 = 2,401</span>

<span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;DROP TABLE IF EXISTS </span><span class="si">{</span><span class="n">tbl_fqn</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="p">(</span>
  <span class="n">df_res</span>
    <span class="o">.</span><span class="n">write</span>
      <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="n">tbl_fqn</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;OPTIMIZE </span><span class="si">{</span><span class="n">tbl_fqn</span><span class="si">}</span><span class="s2"> ZORDER BY (</span><span class="si">{</span><span class="n">cell_col</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This pattern allows us to level out polygon “worst case” max areas, e.g. resolution 5 and then down to 9 for large area boundaries.  You will notice that only <code class="docutils literal notranslate"><span class="pre">is_core</span></code> is checked at resolution 5 which is cheap, then resolution 9 has both <code class="docutils literal notranslate"><span class="pre">is_core</span></code> and <code class="docutils literal notranslate"><span class="pre">st_contains</span></code> in the clause. That query pattern then looks like (showing SQL):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- RESULTS WITH H3 INFORMATION</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">poly_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">pnt_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h3_toparent</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">h3_15</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_cell</span><span class="p">)</span><span class="w">   </span><span class="c1">-- CORE RES=5 MATCH?</span>
<span class="w">    </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h3_toparent</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">h3_15</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_cell</span><span class="p">)</span><span class="w"> </span><span class="c1">-- RES=9 MATCH?</span>
<span class="w">    </span><span class="k">AND</span><span class="p">(</span>
<span class="w">        </span><span class="n">L</span><span class="p">.</span><span class="n">h3_is_core</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">st_contains</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_wkb</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">geom_wkb</span><span class="p">)))</span>
</pre></div>
</div>
<p>Adjust the query as follows for results that strip back the H3 information (more akin to traditional <code class="docutils literal notranslate"><span class="pre">ST_</span></code> functions):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- RESULTS WITHOUT H3 INFORMATION @ GEOMETRY-CENTRIC</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">except</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_res</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_is_core</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_cell</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_wkb</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">h3_15</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">geom_wkb</span><span class="p">)</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">poly_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">pnt_tbl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h3_toparent</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">h3_15</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_cell</span><span class="p">)</span><span class="w">   </span><span class="c1">-- CORE RES=5 MATCH?</span>
<span class="w">    </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h3_toparent</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">h3_15</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="p">.</span><span class="n">h3_cell</span><span class="p">)</span><span class="w"> </span><span class="c1">-- RES=9 MATCH?</span>
<span class="w">    </span><span class="k">AND</span><span class="p">(</span>
<span class="w">        </span><span class="n">L</span><span class="p">.</span><span class="n">h3_is_core</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">st_contains</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">h3_wkb</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">geom_wkb</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="section" id="databricks-photon-apis">
<h2>Databricks Photon APIs<a class="headerlink" href="#databricks-photon-apis" title="Permalink to this headline"></a></h2>
<p>Since DBR 11.2, Databricks <a class="reference external" href="https://docs.databricks.com/runtime/photon.html">Photon Runtimes</a> have delivered <a class="reference external" href="https://docs.databricks.com/sql/language-manual/sql-ref-h3-geospatial-functions.html">H3 APIs</a> that are blazing fast. Mosaic leverages these APIs everywhere possible in its implementation. They are pre-loaded in SQL, meaning Spark SQL on DBR as well as DBSQL.</p>
<p>For python:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.databricks.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>For scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">databricks</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
</div>
<div class="section" id="tuning-tips">
<h2>Tuning Tips<a class="headerlink" href="#tuning-tips" title="Permalink to this headline"></a></h2>
<p>Spark <a class="reference external" href="https://spark.apache.org/docs/latest/sql-performance-tuning.html#adaptive-query-execution">Adaptive Query Exection (AQE)</a> is tuned for data-heavy processing where each row has a cost. It likes those rows to be even and has a hard time reasoning about hidden compute costs as incurred when <code class="docutils literal notranslate"><span class="pre">ST_</span></code> functions, e.g. <code class="docutils literal notranslate"><span class="pre">ST_Contains</span></code> are invoked. To bring more control AQE can be turned completely off:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.databricks.optimizer.adaptive.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># &lt;- default is True</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>                  <span class="c1"># &lt;- default is True</span>
</pre></div>
</div>
<p>AQE can also be left on with other controls more finely managing its behavior, such as:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>                  <span class="c1"># &lt;- default is True, may want False</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.coalescePartitions.parallelismFirst&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>        <span class="c1"># &lt;- default is True (respect size)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.advisoryPartitionSizeInBytes&quot;</span><span class="p">,</span> <span class="s2">&quot;24MB&quot;</span><span class="p">)</span>              <span class="c1"># &lt;- default is 64MB</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.skewJoin.skewedPartitionFactor&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>                 <span class="c1"># &lt;- default is 5</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes&quot;</span><span class="p">,</span> <span class="s2">&quot;64MB&quot;</span><span class="p">)</span>  <span class="c1"># &lt;- default is 256MB</span>
</pre></div>
</div>
<p>Shuffle partition control is also useful for larger data:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>                              <span class="c1"># &lt;- default is 200</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.coalescePartitions.initialPartitionNum&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># &lt;- default is shuffle setting (200)</span>
</pre></div>
</div>
<p>Broadcast thresholds can be useful to manage, e.g. when doing compute heavy operations (vs approximate), you may want to ensure data is partitioned instead of broadcasted:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.autoBroadcastJoinThreshold&quot;</span><span class="p">,</span> <span class="s1">&#39;10485760b&#39;</span><span class="p">)</span>          <span class="c1"># &lt;- default is &#39;10485760b&#39; or 10m (&#39;2147483648b&#39; for 2gb | &#39;0b&#39;)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.adaptive.autoBroadcastJoinThreshold&quot;</span><span class="p">,</span> <span class="s1">&#39;10485760b&#39;</span><span class="p">)</span> <span class="c1"># &lt;- default is &#39;&#39;</span>
</pre></div>
</div>
<p>Adjusting settings for Delta file sizes when also using AQE can be beneficial; however, these are becoming increasingly “smartly” auto-managed:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.databricks.delta.properties.defaults.targetFileSize&quot;</span><span class="p">,</span> <span class="s1">&#39;50331648&#39;</span><span class="p">)</span>     <span class="c1"># &lt;- default is not set (&#39;16777216&#39; for 16MB | &#39;50331648&#39; or 48MB) vs ~128MB</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.databricks.delta.properties.defaults.tuneFileSizesForRewrites&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># &lt;- default is not set</span>
</pre></div>
</div>
<p>There are various partitioning and join hints that may also add advantages when tuning [<a class="reference external" href="https://docs.databricks.com/sql/language-manual/sql-ref-syntax-qry-select-hints.html">Databricks Docs</a> | <a class="reference external" href="https://spark.apache.org/docs/latest/sql-performance-tuning.html#join-strategy-hints-for-sql-queries">Spark Docs</a>].</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="automatic-sql-registration.html" class="btn btn-neutral float-left" title="Automatic SQL registration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../models/models.html" class="btn btn-neutral float-right" title="Models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Databricks Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>